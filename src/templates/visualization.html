<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import Map Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a1a;
      color: #fff;
    }

    #container {
      display: flex;
      height: 100vh;
    }

    #graph {
      flex: 1;
      position: relative;
    }

    #sidebar {
      width: 300px;
      background: #2a2a2a;
      padding: 20px;
      overflow-y: auto;
      border-left: 1px solid #3a3a3a;
    }

    h1 {
      margin: 0 0 20px 0;
      font-size: 1.5em;
      color: #fff;
    }

    .stats {
      margin-bottom: 30px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      padding: 8px;
      background: #1a1a1a;
      border-radius: 4px;
    }

    .legend {
      margin-top: 30px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .controls {
      margin-top: 30px;
    }

    button {
      display: block;
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      background: #4a4a4a;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background: #5a5a5a;
    }

    .node-tooltip {
      position: absolute;
      padding: 10px;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid #555;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      max-width: 300px;
      z-index: 1000;
    }

    .tooltip-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: #fff;
    }

    .tooltip-section {
      margin: 6px 0;
      padding: 4px 0;
      border-top: 1px solid #444;
    }

    .tooltip-section:first-child {
      border-top: none;
    }

    .tooltip-label {
      font-size: 11px;
      margin-top: 3px;
    }

    .search-box {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      background: #1a1a1a;
      color: #fff;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      font-size: 14px;
    }

    .highlighted {
      stroke: #ff0 !important;
      stroke-width: 3px !important;
    }
  </style>
</head>
<body>
  <div class="node-tooltip"></div>
  <div id="container">
    <div id="graph">
      <svg id="svg"></svg>
    </div>
    <div id="sidebar">
      <h1>Import Map</h1>

      <div class="stats">
        <div class="stat-item">
          <span>Total Files:</span>
          <span id="total-nodes">{{TOTAL_NODES}}</span>
        </div>
        <div class="stat-item">
          <span>Total Dependencies:</span>
          <span id="total-links">{{TOTAL_LINKS}}</span>
        </div>
        <div class="stat-item" style="color: #ff6b6b;">
          <span>Runtime Circular:</span>
          <span id="runtime-circular">{{RUNTIME_CIRCULAR}}</span>
        </div>
        <div class="stat-item" style="color: #66aaff;">
          <span>Type-only Circular:</span>
          <span id="type-circular">{{TYPE_CIRCULAR}}</span>
        </div>
      </div>

      <input type="text" class="search-box" placeholder="Search files..." id="search">

      <div class="legend">
        <h3>Categories</h3>
        <div class="legend-item">
          <div class="legend-color" style="background: #ff6b6b;"></div>
          <span>Components</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #4ecdc4;"></div>
          <span>Stores</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #45b7d1;"></div>
          <span>Services</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #96ceb4;"></div>
          <span>Views</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #ffeaa7;"></div>
          <span>Composables</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #dfe6e9;"></div>
          <span>Utils</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #fab1a0;"></div>
          <span>Types</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #a29bfe;"></div>
          <span>External</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #636e72;"></div>
          <span>Other</span>
        </div>

        <h3 style="margin-top: 20px;">Dependencies</h3>
        <div class="legend-item">
          <div style="width: 20px; height: 2px; background: #555; margin-right: 8px;"></div>
          <span>Regular Import</span>
        </div>
        <div class="legend-item">
          <div style="width: 20px; height: 2px; background: #ff6b6b; margin-right: 8px;"></div>
          <span>Circular Dependency</span>
        </div>
        <div class="legend-item">
          <div style="width: 20px; height: 2px; background: #555; border-top: 2px dashed #555; margin-right: 8px;"></div>
          <span>Type-only Import</span>
        </div>
      </div>

      <div class="controls">
        <button onclick="resetZoom()">Reset View</button>
        <button onclick="toggleSimulation()">Toggle Physics</button>
        <button onclick="exportData()">Export Data</button>
      </div>
    </div>
  </div>

  <script>
    const graphData = {{GRAPH_DATA}};

    // Color scheme for different groups
    const colorScale = d3.scaleOrdinal()
      .domain(['components', 'stores', 'services', 'views', 'composables', 'utils', 'types', 'external', 'other'])
      .range(['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9', '#fab1a0', '#a29bfe', '#636e72']);

    // Setup SVG
    const width = window.innerWidth - 300;
    const height = window.innerHeight;

    const svg = d3.select('#svg')
      .attr('width', width)
      .attr('height', height);

    const g = svg.append('g');

    // Setup zoom
    const zoom = d3.zoom()
      .scaleExtent([0.1, 10])
      .on('zoom', (event) => {
        g.attr('transform', event.transform);
      });

    svg.call(zoom);

    // Create force simulation
    const simulation = d3.forceSimulation(graphData.nodes)
      .force('link', d3.forceLink(graphData.links)
        .id(d => d.id)
        .distance(50))
      .force('charge', d3.forceManyBody().strength(-300))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collision', d3.forceCollide().radius(d => Math.sqrt(d.size) * 5));

    // Create links
    const link = g.append('g')
      .selectAll('line')
      .data(graphData.links)
      .enter().append('line')
      .attr('stroke', d => {
        if (d.isCircular) return '#ff6b6b';
        return d.typeOnly ? '#888' : '#555';
      })
      .attr('stroke-opacity', d => {
        if (d.isCircular) return 0.8;
        return d.typeOnly ? 0.4 : 0.6;
      })
      .attr('stroke-width', d => d.isCircular ? Math.sqrt(d.value) * 1.5 : Math.sqrt(d.value))
      .attr('stroke-dasharray', d => d.typeOnly ? '5,3' : 'none');

    // Create nodes
    const node = g.append('g')
      .selectAll('circle')
      .data(graphData.nodes)
      .enter().append('circle')
      .attr('r', d => Math.sqrt(d.size) * 3)
      .attr('fill', d => colorScale(d.group))
      .attr('stroke', d => d.inCircularDep ? '#ff0000' : '#fff')
      .attr('stroke-width', d => d.inCircularDep ? 3 : 1.5)
      .call(drag(simulation));

    // Add labels for important nodes
    const label = g.append('g')
      .selectAll('text')
      .data(graphData.nodes.filter(d => d.size > 10))
      .enter().append('text')
      .text(d => d.label)
      .style('font-size', '10px')
      .style('fill', '#fff')
      .attr('dx', 15)
      .attr('dy', 4);

    // Tooltip
    const tooltip = d3.select('.node-tooltip');

    node.on('mouseover', (event, d) => {
      const connections = graphData.links.filter(l => l.source.id === d.id || l.target.id === d.id);

      const incoming = connections.filter(l => l.target.id === d.id);
      const outgoing = connections.filter(l => l.source.id === d.id);

      let content = `
        <div class="tooltip-title">${d.label}</div>
        <div class="tooltip-section">
          <strong>Group:</strong> ${d.group}<br>
          <strong>Size:</strong> ${d.size} dependencies
        </div>
      `;

      if (d.inCircularDep) {
        content += `
          <div class="tooltip-section">
            <strong style="color: #ff6b6b;">⚠️ In Circular Dependency</strong><br>
            <div class="tooltip-label">Involved in ${d.circularChains?.length || 0} circular chains</div>
          </div>
        `;
      }

      if (incoming.length > 0) {
        content += `
          <div class="tooltip-section">
            <strong>Imported by (${incoming.length}):</strong><br>
            ${incoming.slice(0, 5).map(l => `• ${l.source.label || l.source.id}`).join('<br>')}
            ${incoming.length > 5 ? `<br>... and ${incoming.length - 5} more` : ''}
          </div>
        `;
      }

      if (outgoing.length > 0) {
        content += `
          <div class="tooltip-section">
            <strong>Imports (${outgoing.length}):</strong><br>
            ${outgoing.slice(0, 5).map(l => `• ${l.target.label || l.target.id}${l.typeOnly ? ' (type)' : ''}`).join('<br>')}
            ${outgoing.length > 5 ? `<br>... and ${outgoing.length - 5} more` : ''}
          </div>
        `;
      }

      tooltip
        .style('opacity', 1)
        .html(content)
        .style('left', (event.pageX + 10) + 'px')
        .style('top', (event.pageY + 10) + 'px');
    })
    .on('mouseout', () => {
      tooltip.style('opacity', 0);
    });

    // Update positions
    simulation.on('tick', () => {
      link
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);

      node
        .attr('cx', d => d.x)
        .attr('cy', d => d.y);

      label
        .attr('x', d => d.x)
        .attr('y', d => d.y);
    });

    // Drag behavior
    function drag(simulation) {
      function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
      }

      function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      }

      function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
      }

      return d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended);
    }

    // Search functionality
    document.getElementById('search').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();

      node.classed('highlighted', false);

      if (searchTerm) {
        node.classed('highlighted', d =>
          d.label.toLowerCase().includes(searchTerm) ||
          d.id.toLowerCase().includes(searchTerm)
        );
      }
    });

    // Control functions
    let simulationRunning = true;

    function resetZoom() {
      svg.transition()
        .duration(750)
        .call(zoom.transform, d3.zoomIdentity);
    }

    function toggleSimulation() {
      if (simulationRunning) {
        simulation.stop();
      } else {
        simulation.restart();
      }
      simulationRunning = !simulationRunning;
    }

    function exportData() {
      const dataStr = JSON.stringify(graphData, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

      const exportFileDefaultName = 'import-map.json';

      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }

    // Resize handler
    window.addEventListener('resize', () => {
      const newWidth = window.innerWidth - 300;
      const newHeight = window.innerHeight;

      svg.attr('width', newWidth).attr('height', newHeight);
      simulation.force('center', d3.forceCenter(newWidth / 2, newHeight / 2));
      simulation.alpha(0.3).restart();
    });
  </script>
</body>
</html>